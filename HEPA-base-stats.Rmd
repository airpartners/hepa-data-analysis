
```{r setup}
library(tidyverse)
library(broom)
library(reticulate)
#library(gsubfn)
# py_install("pandas")
source_python("read_pickle.py")

```


```{r}

df_sensor_sn <- read_pickle_file("./hepa-pckls/indoor-outdoor-pairs/48 Putnam Street #1/MOD-PM-00130.pckl")


```


```{r}
df_sensor_sn %>%
  ggplot(aes(timestamp, indoor_opc_bin0)) + 
  geom_line(color = "blue") + 
  geom_line(aes(y = outdoor_opc_bin0, color = "green"))
```


```{r}
# Add Indoor / Outdoor ratio columns to the dataframe

# Create a list of datatypes
bin <- na.omit(str_match(names(df_sensor_sn), "^indoor_(.*)")[,2])

# Create list of cols from og data 
indoor <- df_sensor_sn[paste0("indoor_", bin)]
outdoor <- df_sensor_sn[paste0("outdoor_", bin)]

#create new col names
ratio_name <- paste0("ratio_", bin)

# Calculate new cols and add to dataframe
df_sensor_sn[ratio_name] <- indoor / outdoor
```

```{r}
# bin <- na.omit(str_match(names(df_sensor_sn), "^outdoor_(.*_.*)")[,1])

```


```{r}
# Find statistics for before and after

df_sensor_sn %>%  
  group_by(hepa_installed) %>%
  summarize(across(starts_with("ratio"),
                   list(fifth = ~ quantile(.x, .05, na.rm = TRUE),
                        twentyfifth = ~ quantile(.x, .25, na.rm = TRUE),
                        seventyfifth = ~ quantile(.x, .75, na.rm = TRUE),
                        nintyfifth = ~ quantile(.x, .95, na.rm = TRUE),
                        mean = ~ mean(.x, na.rm = TRUE),
                        median = ~ median(.x, na.rm = TRUE)
                        )
                   )
            ) %>%
  pivot_longer(
    names_to = c(NA, "bin1", "bin2", ".value"),
    names_sep = "_",
    cols = -c(hepa_installed)
  )

```












